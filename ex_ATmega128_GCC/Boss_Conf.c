/*
*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*
*                                                                             *
*                 RT-BOSS (Config File)         [ ATmega128 ]                 *
*                                                                             *
*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*
*/

/*===========================================================================*/
/*                               INCLUDE FILE                                */
/*---------------------------------------------------------------------------*/
#include "Boss.h"
#include <avr/io.h>
#include <avr/interrupt.h>

/*===========================================================================*/
/*                      DEFINITIONS & TYPEDEFS & MACROS                      */
/*---------------------------------------------------------------------------*/

/*===========================================================================*/
/*                             GLOBAL VARIABLES                              */
/*---------------------------------------------------------------------------*/

/*===========================================================================*/
/*                            FUNCTION PROTOTYPES                            */
/*---------------------------------------------------------------------------*/
void _ATmega128_timer1_init(void);
void _printf_initial(void);

/*===========================================================================
   Timer Compare Match A  (ATmega128 Timer1 ISR)
---------------------------------------------------------------------------*/
ISR(TIMER1_COMPA_vect)
{
  _BOSS_ISR_BEGIN();
  {
    _Boss_timer_tick(_BOSS_TICK_MS_);
  }
  _BOSS_ISR_FINIS();
}


/*===========================================================================
    D E V I C E _ I N I T
---------------------------------------------------------------------------*/
void device_init(void)
{
  _ATmega128_timer1_init();
  _printf_initial();
}


/*===========================================================================
    _   A   T M E G A 1 2 8 _ T I M E R 1 _ I N I T
---------------------------------------------------------------------------*/
void _ATmega128_timer1_init(void)
{
  TCCR1A = 0x00;            /* WGM1[3:0] = 4 (CTC)              */
  TCCR1B = 0x0A;            /* prescaler = 8                    */
  TCCR1C = 0x00;

  OCR1A  = 20000 - 1;       /* (8 * (1 + 19999) ) / 16MHZ = 10ms */

  TCNT1  = 0;               /* Clear counter1                   */ 
  TIMSK = 1 << OCIE1A;      /* Enable OC1A interrupt            */
}


/*===========================================================================
    _ P U T _ C H A R
---------------------------------------------------------------------------*/
int _put_char(char c, FILE *fp)
{  
  while ( !( UCSR0A & (1<<UDRE0)) );
  UDR0 = c;
  
  return c;
}


/*===========================================================================
    _ P R I N T F _ I N I T I A L
---------------------------------------------------------------------------*/
void _printf_initial(void)
{
  /* Set baud rate (16Mhz 115200bps) */
  UBRR0H = 0;
  UBRR0L = 8;
  UCSR0A &= ~(1 << U2X0);     /* Disable Double USART Speed */

  /* Enable receiver and transmitter  */
  UCSR0B = (1<<RXEN0) | (1<<TXEN0);
 
  /* Set frame format: 8data, 1stop bit */
  UCSR0C = (3 << UCSZ00);

  (void)fdevopen(_put_char, NULL);
}


/*===========================================================================
    _ A S S E R T
---------------------------------------------------------------------------*/
void _assert(const char *file, unsigned int line)
{
  cli();
  PRINTF("\r\n ASSERT :");
  printf_P(file);
  PRINTF(" %d", line);
  for(;;)
  {
  }
}


/*
*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*
*                                                                             *
*                         RT-BOSS ( IDLE TASK )                               *
*                                                                             *
*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*=====*
*/

boss_tcb_t idle_tcb;
boss_stk_t idle_stack[ _IDLE_STACK_BYTES / sizeof(boss_stk_t) ];

/*===========================================================================
    I D L E _ M A I N
---------------------------------------------------------------------------*/
void idle_main(void *p_arg)
{
  for(;;)
  {
  }
}

